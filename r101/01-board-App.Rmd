---
title: "COVID-19 in US"
runtime: shiny
output: 
  flexdashboard::flex_dashboard:
    orientation: columns
    vertical_layout: fill
---

```{r readCovidUS , include=FALSE}
library(flexdashboard)

knitr::opts_chunk$set(echo = FALSE)
source("01-read.R")
dtGeo <- readGeo()
dtGeo[city == 'New York City', city:='New York']
dtUS <- readCovidUS() 
dateMax<- dtUS$date %>% max %>% ymd; dateMax
```

# Settings {.sidebar}
```{r input daysToTrack showN}
selectInput("state", "Choose State:",
            multiple=F, 
            selected = "New York",
            choices = dtUS$state %>% unique
)


sliderInput("showN", 
            label = "Narrow output to (put 0 to show all):",
            pre = "top ",
            post  = " cities",
            min = 0, max = 49, value = 6)

hr()

sliderInput("daysToTrack", label = "Days to track:",
            min = 7, max = 90, value=30)


checkboxInput("scale", "Keep scale constant", F)

# checkboxInput("sortby", "Order alphabetically", F)

# checkboxInput("deaths", "Show deaths (instead of confirmed)", F)

```


```{r r.dt, include=FALSE}
# set my.state ----



r.dt <- reactive({
  
  my.state=input$state # "New York"
  
  dt <- dtGeo [ dtUS [state == my.state], on=c("country" , "state" , "city")];dt
  
  if ( input$showN > 0 )
    dt <- dt %>% covid.reduceToTopNCitiesToday(input$showN) 
  
  dt[, recovered:=NULL]
  dt[, confirmedPercentage:=round(confirmed/population*100,1)]
  dt[, confirmedTotal:= lapply(confirmed, cumsum)]
  # dt[, confirmedTotalPercentage:= round(confirmedTotal/population*100,1)]
  dt
})

```


# Map

## Column name not printed {data-width=1000}

### Map

```{r}

library(leaflet)

renderLeaflet({
  
  dtToday <- r.dt()[date==dateMax] 
  my.mean <-  dtToday$confirmed %>% mean()
  
  dtToday[, ratingcol:= ifelse(confirmed<my.mean, "yellow", "red")]
  dtToday[, strMessage:= paste0(city, 
                                # ":<br>Total: ", confirmedTotal, "(", confirmedTotalPercentage, "%)", 
                                "<br>Daily: ", confirmed, "(", confirmedPercentage, "% population)" 
                                )]
  
  leaflet::leaflet(dtToday) %>% 
    addTiles() %>%
    addCircleMarkers(~lng, ~lat, 
                     color = ~ratingcol, 
                     popup = ~strMessage,
                     label = ~paste0(city, ": ", confirmed, "(", confirmedPercentage, "%) / day") 
    ) %>% 
    addPopups(~lng,  ~lat, 
              popup = ~paste0(city, ": ", confirmed, " / day") 
    )  %>%
    addLegend("bottomleft",
              colors = c("yellow","red"),
              labels = c(
                "Accelerates slowly",
                "Accelerates rapidly"),
              opacity = 0.7)
  
})
```


# Table

## Column name not printed 


### Today  {data-height=1000}

```{r}
DT::renderDataTable({
  DT::datatable(r.dt() [date==dateMax])
})
```



# Trends

## This caption is not printed {.tabset .tabset-fade } 

### Dynamics over time

```{r fig.width=12, fig.height=9, fig.align='center'}


r.gTrend <- reactive({
  r.dt() [ date > dateMax - input$daysToTrack] %>% 
    # covid.reduceToTopNCitiesToday(input$showN) %>% 
    ggplot() + 
    # facet_wrap( . ~ reorder(city, -confirmed), scales="free") +
    facet_wrap( . ~  reorder(city, -confirmed),
                  # ifelse(input$sortby, city, reorder(city, -confirmed)), 
                scales=ifelse(input$scale, "fixed", "free")) +  
    geom_line(aes(date, confirmed), col="orange") +
    labs(
      title= paste0("Infected per day"),
      subtitle=paste0("State: ", input$state, ". Date: ", dateMax, " (Cities are sorted by the number of infected)"),  
      caption=paste0( 
        "Data source: Johns Hopkins University U.S. Coronavirus database\n",
        "Generated by R Ottawa"
      )
    )
  
  
  
})

renderPlot( {
  print( r.gTrend() )
})

```

### Interactive plot

```{r}
library(plotly)
renderPlotly( {
  ggplotly( r.gTrend() )
})

```


# Info

## Column
<!-- ## Column {.tabset .tabset-fade } -->

### About App

title: "COVID-19 in US"    
subtitle: "Situational Analysis Report"    
author: "Prepared by: [R Ottawa community](https://ivi-m.github.io/R-Ottawa/)"   
<!-- date: "Last updated: `r format (Sys.time(), '%d %B, %Y')`"    -->
date: "Last updated: `3 June 2020`"    

### Data source

This report is generated automatically. 

The COVID-19 data is taken from:   

- [Johns Hopkins University U.S. Coronavirus database](https://coronavirus.jhu.edu/us-map), which is available at this [GitHub repository](https://github.com/CSSEGISandData/COVID-19).

This database was last updated on `r dateMax`.
