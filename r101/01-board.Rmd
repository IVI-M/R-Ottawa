---
title: "COVID-19 in US"
output: 
  flexdashboard::flex_dashboard:
    orientation: columns
    vertical_layout: fill
---

```{r setup, include=FALSE}
library(flexdashboard)

knitr::opts_chunk$set(echo = FALSE)
source("01-read.R")
dtGeo <- readGeo()
dtGeo[city == 'New York City', city:='New York']
dtUS <- readCovidUS() 
dateMax<- dtUS$date %>% max %>% ymd; dateMax

my.state="New York"

dt <- dtGeo [ dtUS [state == my.state], on=c("country" , "state" , "city")];dt

dt[, recovered:=NULL]
dt[, confirmedPercentage:=confirmed/population*100]
dt[, confirmedTotal:= lapply(confirmed, cumsum)]
dt[, confirmedPercentageTotal:= lapply(confirmedPercentage, cumsum)]

```

# Map

## Column not printed {data-width=1000}

### Map

```{r}

dtToday <- dt[date==dateMax]
my.mean <-  dtToday$confirmed %>% mean()

dtToday[, ratingcol:= ifelse(confirmed<my.mean, "yellow", "red")]
dtToday[, strMessage:= paste0(city, "<br>Percentage: ", confirmedPercentage, 
                                   "<br>Total: ", confirmedTotal)]
library(leaflet)
leaflet::leaflet(dtToday) %>% 
  addTiles() %>%
  addCircleMarkers(~lng, ~lat, 
                   color = ~ratingcol, 
                   popup = ~strMessage,
                   label = ~paste0(city, ": ", confirmed)
  ) %>% 
  addPopups(~lng,  ~lat, 
            popup = ~paste0(city, ": ", confirmed) 
  )  %>%
  addLegend("bottomleft",
            colors = c("yellow","red"),
            labels = c(
              "Accelerates slowly",
              "Accelerates rapidly"),
            opacity = 0.7)

```


# Table

## Column name not printed 


### Today  {data-height=1000}

```{r}
DT::datatable(dt[date==dateMax])
```



# Trends

## This line is not printed

### Dynamics over time

```{r fig.width=12, fig.height=9, fig.align='center'}

dt [ date > dateMax - 30] %>% 
  covid.reduceToTopNCitiesToday(6) %>% 
  ggplot() + 
  facet_wrap( reorder(city, -confirmed) ~ .) + #, scales="free") +
  geom_line(aes(date, confirmed), col="orange") +
  labs(
    title= paste0("Infected per day"),
    subtitle=paste0("State: ", my.state, ". Date: ", dateMax, " (Cities are sorted by the number of infected)"),  
    caption=paste0( 
      "Data source: Johns Hopkins University U.S. Coronavirus database\n",
      "Generated by R Ottawa"
    )
  )


```



# Info

## Column
<!-- ## Column {.tabset .tabset-fade } -->

### About

title: "COVID-19 in US"    
subtitle: "Situational Analysis Report"    
author: "Prepared by: [R Ottawa community](https://ivi-m.github.io/R-Ottawa/)"   
date: "Last updated: `r format (Sys.time(), '%d %B, %Y')`"   

### Data source

This report is generated automatically. 

The COVID-19 data is taken from:   

- [Johns Hopkins University U.S. Coronavirus database](https://coronavirus.jhu.edu/us-map), which is available at this [GitHub repository](https://github.com/CSSEGISandData/COVID-19).

This database was last updated on `r dateMax`.
